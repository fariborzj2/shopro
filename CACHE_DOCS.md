# مستندات سیستم کشینگ (Enterprise Caching System)

این سیستم برای بهبود سرعت بارگذاری و کاهش فشار روی دیتابیس طراحی شده است.

## نحوه استفاده (Developers)

### ۱. کش کردن داده‌ها (Query Caching)
برای کش کردن نتیجه کوئری‌های سنگین دیتابیس از متد `remember` استفاده کنید. این متد به صورت خودکار از **Locking** برای جلوگیری از Cache Stampede استفاده می‌کند.

```php
use App\Core\Cache;

$products = Cache::getInstance()->remember('home_products', 3600, function() {
    // این بخش فقط در صورت نبودن کش اجرا می‌شود
    return \App\Models\Product::findAll(['featured' => 1]);
}, ['products', 'home']); // تگ‌ها برای پاکسازی
```

### ۲. کش HTML (Full Page Cache)
این قابلیت به صورت خودکار در `public/index.php` فعال شده است و صفحات را فقط برای **کاربران مهمان (Guest)** کش می‌کند.
*   **CSRF Token:** سیستم به صورت هوشمند توکن‌های CSRF را در صفحات کش شده با توکن جدید جایگزین می‌کند تا فرم‌ها کار کنند.
*   **تنظیمات:** فعال‌سازی و مدت زمان کش در پنل ادمین قابل تنظیم است.

### ۳. پاکسازی کش (Invalidation)
برای پاکسازی کش هنگام بروزرسانی داده‌ها:

```php
// پاکسازی یک آیتم خاص
Cache::getInstance()->delete('home_products');

// پاکسازی گروهی (مثلاً همه کش‌های مربوط به محصولات)
Cache::getInstance()->invalidateTag('products');

// پاکسازی کامل (Flush)
Cache::getInstance()->flush();
```

---

## راهنمای پنل ادمین

۱. به مسیر **تنظیمات > کشینگ (Cache)** بروید.
۲. **اطلاعات اتصال Redis:** آدرس هاست (پیش‌فرض `127.0.0.1`) و پورت را وارد کنید. اگر Redis رمز دارد، آن را وارد کنید.
۳. **کش HTML:**
    *   **فعال‌سازی:** تیک "فعال‌سازی کش HTML برای مهمان‌ها" را بزنید.
    *   **مدت زمان:** زمان پیشنهادی ۶۰۰ ثانیه (۱۰ دقیقه) است.
    *   **استثناها:** آدرس‌هایی که نباید کش شوند (مثل `/contact`) را وارد کنید.
۴. دکمه **پاکسازی کامل کش** برای حذف تمام داده‌های کش شده موجود است.

---

## راهنمای CDN (Cloudflare)

سیستم قابلیت ارسال درخواست Purge به کلودفلر را دارد. برای فعال‌سازی، مقادیر زیر را در فایل `.env` یا تنظیمات سرور وارد کنید:

```env
CLOUDFLARE_ZONE_ID=your_zone_id
CLOUDFLARE_API_TOKEN=your_api_token
```

در صورت تنظیم بودن این مقادیر، هنگام استفاده از `invalidateTag`، سیستم به صورت خودکار درخواست حذف کش را به کلودفلر ارسال می‌کند.
